name: SPDX validation
on:
  - pull_request
  - push

jobs:
  SPDX_Validation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout spdx-examples
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  #v4.2.2

      - name: Look for files with the wrong location
        run: |
          find . \( -name '*.spdx' -o -name '*.json' \) \
            -not -path './presentations/*' \
            -not -path '*/content/*' \
            -not -path './tools-java/*' \
            -not -path '*/spdx2.2/*' \
            -not -path '*/spdx2.3/*' \
            -not -path '*/spdx3.0/*' > flist.txt

          if [ "$(cat flist.txt | wc -l)" != "0" ]; then
            echo "SPDX JSON files are only expected in these locations:"
            echo "./presentations/"
            echo "./tools-java/"
            echo "*/spdx2.2/"
            echo "*/spdx2.3/"
            echo "*/spdx3.0/"
            echo ""
            echo "The following files are in the wrong location and will not be checked:"
            cat flist.txt
            exit 1
          fi

      - name: Look for files with the wrong extension
        run: |
          find . -name '*.jsonld' > flist.txt

          if [ "$(cat flist.txt | wc -l)" != "0" ]; then
            echo "SPDX JSON can only has these extensions:"
            echo "*.spdx"
            echo "*.json"
            echo ""
            echo "The following files have the wrong extension and will not be checked:"
            cat flist.txt
            exit 1
          fi

      - name: Update apt
        run: |
          sudo apt update -y

      - name: Setup Java tools
        env:
          VERSION: 2.0.0-RC2
        run: |
          sudo apt install -y default-jdk
          curl --location https://repo1.maven.org/maven2/org/spdx/tools-java/${VERSION}/tools-java-${VERSION}-jar-with-dependencies.jar --output tools-java.jar

      - name: Setup Python tools
        run: |
          python3 -m pip install -U pip
          python3 -m pip install spdx3-validate

      - name: Validate SPDX 2.2 & SPDX 2.3 Documents
        continue-on-error: true
        run: |
          set +e
          EXIT_CODE=0
          TOTAL_COUNT=0
          PASSED_COUNT=0
          FAILURE_COUNT=0
          FAILED_FILES=""

          for f in $(find . \( -path '*/spdx2.2/*' -o -path '*/spdx2.3/*' \) \( -name *.spdx -o -name *.json \)); do
              echo "Checking $f..."
              TOTAL_COUNT=$((TOTAL_COUNT + 1))
              java -jar tools-java.jar Verify "$f"
              if [ $? -eq 0 ]; then
                  PASSED_COUNT=$((PASSED_COUNT + 1))
              else
                  FAILURE_COUNT=$((FAILURE_COUNT + 1))
                  FAILED_FILES="$FAILED_FILES\n$f"
                  EXIT_CODE=1
              fi
          done

          echo ""
          echo "Files tested: $TOTAL_COUNT"
          echo "Files passed: $PASSED_COUNT"
          echo "Files failed: $FAILURE_COUNT"

          if [ $FAILURE_COUNT -ne 0 ]; then
              echo ""
              echo "Failed files:"
              echo -e "$FAILED_FILES"
          fi

          if [ $EXIT_CODE -ne 0 ]; then
              exit $EXIT_CODE
          fi

      - name: Validate SPDX 3.0 Documents
        run: |
          for f in $(find . -type f -path '*/spdx3.0/*.json'); do
              echo "Checking $f..."
              TOTAL_COUNT=$((TOTAL_COUNT + 1))
              spdx3-validate -j $f
              if [ $? -eq 0 ]; then
                  PASSED_COUNT=$((PASSED_COUNT + 1))
              else
                  FAILURE_COUNT=$((FAILURE_COUNT + 1))
                  FAILED_FILES="$FAILED_FILES\n$f"
                  EXIT_CODE=1
              fi
          done

          echo ""
          echo "Files tested: $TOTAL_COUNT"
          echo "Files passed: $PASSED_COUNT"
          echo "Files failed: $FAILURE_COUNT"

          if [ $FAILURE_COUNT -ne 0 ]; then
              echo ""
              echo "Failed files:"
              echo -e "$FAILED_FILES"
          fi

          if [ $EXIT_CODE -ne 0 ]; then
              exit $EXIT_CODE
          fi
